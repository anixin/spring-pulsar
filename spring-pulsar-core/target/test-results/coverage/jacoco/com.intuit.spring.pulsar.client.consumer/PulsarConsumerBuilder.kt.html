<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PulsarConsumerBuilder.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Spring Pulsar Core</a> &gt; <a href="index.source.html" class="el_package">com.intuit.spring.pulsar.client.consumer</a> &gt; <span class="el_source">PulsarConsumerBuilder.kt</span></div><h1>PulsarConsumerBuilder.kt</h1><pre class="source lang-java linenums">package com.intuit.spring.pulsar.client.consumer

import com.intuit.spring.pulsar.client.config.AckConfig
import com.intuit.spring.pulsar.client.config.DeadLetterPolicyConfig
import com.intuit.spring.pulsar.client.config.PulsarConsumerConfig
import com.intuit.spring.pulsar.client.config.QueueConfig
import com.intuit.spring.pulsar.client.config.SubscriptionConfig
import com.intuit.spring.pulsar.client.config.TopicConfig
import com.intuit.spring.pulsar.client.utils.convertToPropertiesMap
import org.apache.pulsar.client.api.ConsumerBuilder
import org.apache.pulsar.client.api.ConsumerCryptoFailureAction
import org.apache.pulsar.client.api.MessageListener
import org.apache.pulsar.client.api.PulsarClient
import org.apache.pulsar.client.api.RegexSubscriptionMode
import org.apache.pulsar.client.api.Schema
import org.apache.pulsar.client.api.SubscriptionInitialPosition
import org.apache.pulsar.client.api.SubscriptionType
import java.util.concurrent.TimeUnit

/**
 * Builder class to populate low level pulsar consumer
 * builder object with defined client properties
 */
<span class="fc" id="L24">class PulsarConsumerBuilder&lt;T&gt;(pulsarClient: PulsarClient, schema: Schema&lt;T&gt;) {</span>

<span class="fc" id="L26">    private val builder: ConsumerBuilder&lt;T&gt; = pulsarClient.newConsumer(schema)</span>

    /**
     * Populate consumer properties in builder
     */
    fun withConsumerConfig(consumer: PulsarConsumerConfig): PulsarConsumerBuilder&lt;T&gt; {
<span class="fc bfc" id="L32" title="All 2 branches covered.">        if (Int.MIN_VALUE != consumer.priorityLevel) {</span>
<span class="fc" id="L33">            builder.priorityLevel(consumer.priorityLevel)</span>
        }
<span class="fc bfc" id="L35" title="All 4 branches covered.">        if (consumer.cryptoFailureAction.isNotBlank()) {</span>
<span class="fc" id="L36">            builder.cryptoFailureAction(ConsumerCryptoFailureAction.valueOf(consumer.cryptoFailureAction))</span>
        }
<span class="fc bfc" id="L38" title="All 4 branches covered.">        if (consumer.properties.isNotEmpty()) {</span>
<span class="fc" id="L39">            builder.properties(convertToPropertiesMap(consumer.properties))</span>
        }
<span class="fc" id="L41">        withAckConfig(consumer.ack)</span>
<span class="fc" id="L42">        withQueueConfig(consumer.queue)</span>
<span class="fc" id="L43">        withDeadLetterPolicy(consumer.deadLetterPolicy)</span>
<span class="fc" id="L44">        withSubscriptionConfig(consumer.subscription)</span>
<span class="fc" id="L45">        withTopicConfig(consumer.topic)</span>
<span class="fc" id="L46">        return this</span>
    }

    /**
     * Populate topic properties in builder
     */
    fun withTopicConfig(topic: TopicConfig): PulsarConsumerBuilder&lt;T&gt; {
<span class="fc bfc" id="L53" title="All 4 branches covered.">        if (topic.topicsPattern.isNotBlank()) {</span>
<span class="fc" id="L54">            builder.topicsPattern(topic.topicsPattern)</span>
        }
<span class="fc bfc" id="L56" title="All 4 branches covered.">        if (topic.topicNames.isNotBlank()) {</span>
<span class="fc" id="L57">            builder.topic(topic.topicNames)</span>
        }
<span class="fc" id="L59">        return this</span>
    }

    /**
     * Populate queue properties in builder
     */
    fun withQueueConfig(queue: QueueConfig): PulsarConsumerBuilder&lt;T&gt; {
<span class="fc" id="L66">        builder.readCompacted(queue.readCompacted)</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">        if (Int.MIN_VALUE != queue.patternAutoDiscoveryPeriod) {</span>
<span class="fc" id="L68">            builder.patternAutoDiscoveryPeriod(queue.patternAutoDiscoveryPeriod)</span>
        }
<span class="fc" id="L70">        builder.autoUpdatePartitions(queue.autoUpdatePartitions)</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">        if (Int.MIN_VALUE != queue.receiverQueueSize) {</span>
<span class="fc" id="L72">            builder.receiverQueueSize(queue.receiverQueueSize)</span>
        }
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (Int.MIN_VALUE != queue.maxTotalReceiverQueueSizeAcrossPartitions) {</span>
<span class="fc" id="L75">            builder.maxTotalReceiverQueueSizeAcrossPartitions(</span>
<span class="fc" id="L76">                queue.maxTotalReceiverQueueSizeAcrossPartitions!!</span>
            )
        }
<span class="fc" id="L79">        return this</span>
    }

    /**
     * Populate ack properties in builder
     */
    fun withAckConfig(ack: AckConfig): PulsarConsumerBuilder&lt;T&gt; {
<span class="fc bfc" id="L86" title="All 4 branches covered.">        if (ack.acknowledgementsGroupTime.isNotBlank()) {</span>
<span class="fc" id="L87">            builder.acknowledgmentGroupTime(ack.acknowledgementsGroupTime.toLong(), TimeUnit.MILLISECONDS)</span>
        }
<span class="fc bfc" id="L89" title="All 4 branches covered.">        if (ack.ackTimeout.isNotBlank()) {</span>
<span class="fc" id="L90">            builder.ackTimeout(ack.ackTimeout.toLong(), TimeUnit.MILLISECONDS)</span>
        }
<span class="fc bfc" id="L92" title="All 4 branches covered.">        if (ack.tickDuration.isNotBlank()) {</span>
<span class="fc" id="L93">            builder.ackTimeoutTickTime(ack.tickDuration.toLong(), TimeUnit.MILLISECONDS)</span>
        }
<span class="fc" id="L95">        return this</span>
    }

    /**
     * Populate dead letter properties in builder
     */
    fun withDeadLetterPolicy(deadLetterPolicy: DeadLetterPolicyConfig): PulsarConsumerBuilder&lt;T&gt; {

<span class="fc bfc" id="L103" title="All 2 branches covered.">        if (Int.MIN_VALUE != deadLetterPolicy.maxRedeliverCount</span>
<span class="fc bfc" id="L104" title="All 4 branches covered.">            || deadLetterPolicy.retryLetterTopic.isNotBlank()</span>
<span class="fc bfc" id="L105" title="All 4 branches covered.">            || deadLetterPolicy.deadLetterTopic.isNotBlank()</span>
        ) {
<span class="fc" id="L107">            val policyBuilder = org.apache.pulsar.client.api.DeadLetterPolicy.builder()</span>
<span class="fc bfc" id="L108" title="All 4 branches covered.">            if (deadLetterPolicy.deadLetterTopic.isNotBlank()) {</span>
<span class="fc" id="L109">                policyBuilder.deadLetterTopic(deadLetterPolicy.deadLetterTopic)</span>
            }
<span class="fc bfc" id="L111" title="All 4 branches covered.">            if (deadLetterPolicy.retryLetterTopic.isNotBlank()) {</span>
<span class="fc" id="L112">                policyBuilder.retryLetterTopic(deadLetterPolicy.retryLetterTopic)</span>
            }
<span class="fc bfc" id="L114" title="All 2 branches covered.">            if (Int.MIN_VALUE != deadLetterPolicy.maxRedeliverCount) {</span>
<span class="fc" id="L115">                policyBuilder.maxRedeliverCount(deadLetterPolicy.maxRedeliverCount!!)</span>
            }
<span class="fc" id="L117">            builder.enableRetry(true)</span>
<span class="fc" id="L118">            builder.deadLetterPolicy(policyBuilder.build())</span>
        }
<span class="fc bfc" id="L120" title="All 4 branches covered.">        if (deadLetterPolicy.negativeAckRedeliveryDelay.isNotBlank()) {</span>
<span class="fc" id="L121">            builder.negativeAckRedeliveryDelay(</span>
<span class="fc" id="L122">                deadLetterPolicy.negativeAckRedeliveryDelay.toLong(),</span>
<span class="fc" id="L123">                TimeUnit.MILLISECONDS</span>
            )
        }
<span class="fc" id="L126">        return this</span>
    }

    /**
     * Populate subscription properties in builder
     */
    fun withSubscriptionConfig(subscriptionConfig: SubscriptionConfig): PulsarConsumerBuilder&lt;T&gt; {
<span class="fc" id="L133">        builder.replicateSubscriptionState(subscriptionConfig.replicateSubscriptionState)</span>
<span class="fc bfc" id="L134" title="All 4 branches covered.">        if (subscriptionConfig.subscriptionName.isNotBlank()) {</span>
<span class="fc" id="L135">            builder.subscriptionName(subscriptionConfig.subscriptionName)</span>
        }
<span class="fc bfc" id="L137" title="All 4 branches covered.">        if (subscriptionConfig.subscriptionType.isNotBlank()) {</span>
<span class="fc" id="L138">            builder.subscriptionType(SubscriptionType.valueOf(subscriptionConfig.subscriptionType))</span>
        }
<span class="fc bfc" id="L140" title="All 4 branches covered.">        if (subscriptionConfig.subscriptionInitialPosition.isNotBlank()) {</span>
<span class="fc" id="L141">            builder.subscriptionInitialPosition(</span>
                SubscriptionInitialPosition
<span class="fc" id="L143">                    .valueOf(subscriptionConfig.subscriptionInitialPosition)</span>
            )
        }
<span class="fc bfc" id="L146" title="All 4 branches covered.">        if (subscriptionConfig.regexSubscriptionMode.isNotBlank()) {</span>
<span class="fc" id="L147">            builder.subscriptionTopicsMode(RegexSubscriptionMode.valueOf(subscriptionConfig.regexSubscriptionMode))</span>
        }
<span class="fc" id="L149">        return this</span>
    }

    /**
     * Add a message listener in builder
     */
    fun withListener(messageListener: MessageListener&lt;*&gt;): PulsarConsumerBuilder&lt;T&gt; {
<span class="fc" id="L156">        builder.messageListener(messageListener as MessageListener&lt;T&gt;)</span>
<span class="fc" id="L157">        return this</span>
    }

    /**
     * Return the low level pulsar consumer builder
     */
    fun build(): ConsumerBuilder&lt;T&gt; {
<span class="fc" id="L164">        return builder</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>
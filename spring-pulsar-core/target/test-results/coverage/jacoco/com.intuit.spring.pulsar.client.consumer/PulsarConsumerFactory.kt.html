<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PulsarConsumerFactory.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Spring Pulsar Core</a> &gt; <a href="index.source.html" class="el_package">com.intuit.spring.pulsar.client.consumer</a> &gt; <span class="el_source">PulsarConsumerFactory.kt</span></div><h1>PulsarConsumerFactory.kt</h1><pre class="source lang-java linenums">package com.intuit.spring.pulsar.client.consumer

import com.intuit.spring.pulsar.client.annotations.extractor.AnnotationDetail
import com.intuit.spring.pulsar.client.client.IPulsarClientFactory
import com.intuit.spring.pulsar.client.config.SchemaConfig
import com.intuit.spring.pulsar.client.config.SchemaType
import com.intuit.spring.pulsar.client.exceptions.PulsarConsumerAnnotationNotFoundSpringException
import org.apache.pulsar.client.api.Consumer
import org.apache.pulsar.client.api.ConsumerBuilder
import org.apache.pulsar.client.api.Schema
import org.springframework.stereotype.Component


/**
 * Contract to create [Consumer]
 */
interface IPulsarConsumerFactory&lt;T&gt; {

    /**
     * Method used to create low level [Consumer]
     */
    fun createConsumer(annotationDetail: AnnotationDetail)
}


/**
 * Creates consumer builder object using consumer config.
 * Act as a factory for creating low level pulsar consumer.
 */
<span class="fc" id="L30">@Suppress(&quot;UNCHECKED_CAST&quot;)</span>
@Component
<span class="fc" id="L32">class PulsarConsumerFactory&lt;T&gt;(</span>
<span class="fc" id="L33">    private val clientFactory: IPulsarClientFactory</span>
) : IPulsarConsumerFactory&lt;T&gt; {

    /**
     * Creates low level pulsar [ConsumerBuilder]
     * Uses the client name to fetch the consumer config from
     * properties file, and creates a consumer builder using the
     * fetched properties.If the passed clientName does not have
     * any consumer defined in props throws [PulsarConsumerAnnotationNotFoundSpringException]
     */
    override fun createConsumer(annotationDetail: AnnotationDetail) {
<span class="fc" id="L44">        var consumerCount: Int = annotationDetail.pulsarConsumer.count</span>
<span class="fc bfc" id="L45" title="All 2 branches covered.">        while (consumerCount &gt; 0) {</span>
<span class="fc" id="L46">            startConsumer(createPulsarConsumer(annotationDetail))</span>
<span class="fc" id="L47">            consumerCount -= 1;</span>
        }
<span class="fc" id="L49">    }</span>

    /**
     * Creates and return a Pulsar Consumer builder of type
     * [ConsumerBuilder]
     */
    private fun createPulsarConsumer(annotationDetail: AnnotationDetail): ConsumerBuilder&lt;T&gt; {
<span class="fc" id="L56">        val pulsarClient = clientFactory.getClient()</span>
<span class="fc" id="L57">        return PulsarConsumerBuilder(pulsarClient, createSchema(annotationDetail.pulsarConsumer.schema))</span>
<span class="fc" id="L58">            .withConsumerConfig(annotationDetail.pulsarConsumer)</span>
<span class="fc" id="L59">            .withListener(annotationDetail.bean)</span>
<span class="fc" id="L60">            .build()</span>
    }

    /**
     * Subscribe to topics and creates a [Consumer].
     * Returns the [Consumer] created.
     */
    private fun startConsumer(consumerBuilder: ConsumerBuilder&lt;T&gt;): Consumer&lt;T&gt;? {
<span class="fc" id="L68">        return consumerBuilder.subscribe()</span>
    }

    private fun createSchema(definedSchema: SchemaConfig)
            : Schema&lt;T&gt; {
<span class="fc bfc" id="L73" title="All 3 branches covered.">        return when (definedSchema.type) {</span>
<span class="fc" id="L74">            SchemaType.BYTES -&gt; Schema.BYTES</span>
<span class="fc" id="L75">            SchemaType.AVRO -&gt; Schema.AVRO(definedSchema.typeClass.java)</span>
<span class="fc" id="L76">            SchemaType.JSON -&gt; Schema.JSON(definedSchema.typeClass.java)</span>
        } as Schema&lt;T&gt;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>